name: ðŸ”– R3C Rust-LTSS Autonomous Stable Release v2.1 (PAT Fixed)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - ".github/workflows/**"
  schedule:
    - cron: "0 0 * * 0"   # âœ… ë§¤ì£¼ ì¼ìš”ì¼ 00:00 UTC ìžë™ ì‹¤í–‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  verify-and-build:
    name: ðŸ§± Verify & Build (3OS)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: ðŸ§­ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ¦€ Setup Rust 1.70.0
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.70.0

      - name: âš™ï¸ Verify Rust version
        run: |
          echo "ðŸ” Checking rustc version..."
          rustc --version
          if ! rustc --version | grep -q "1.70.0"; then
            echo "âŒ Rust version mismatch. Aborting."
            exit 1
          fi

      - name: ðŸ§± Build release (conditional)
        run: |
          if [ -f Cargo.toml ]; then
            echo "âœ… Cargo.toml found â€” running cargo build..."
            cargo build --release
          else
            echo "âš ï¸ No Cargo.toml found â€” skipping cargo build."
            mkdir -p target/ltss
            echo "R3C Rust-LTSS placeholder build successful." > target/ltss/BUILD_LOG.txt
          fi

      - name: ðŸ”’ Generate SHA256SUMS
        run: |
          mkdir -p artifacts
          cp -r target/ltss/* artifacts/ || true
          cd artifacts
          if command -v sha256sum >/dev/null; then
            sha256sum * > ../SHA256SUMS_${{ matrix.os }}.txt
          else
            shasum -a 256 * > ../SHA256SUMS_${{ matrix.os }}.txt
          fi
          cd ..

      - name: ðŸ“¦ Upload OS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ltss-${{ matrix.os }}
          path: artifacts/

  unify-and-release:
    name: ðŸš€ Auto Commit + Tag + Release
    needs: verify-and-build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§­ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: builds

      - name: ðŸ” Merge SHA256SUMS files
        run: |
          cat builds/**/SHA256SUMS_* > SHA256SUMS.txt
          echo "ðŸ§¾ Combined SHA256SUMS:"
          cat SHA256SUMS.txt

      - name: ðŸ”– Generate release tag
        id: tag
        run: |
          TAG="r3c-rust1.70-ltss-v$(date +'%Y.%m.%d')-stable-final"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "ðŸª¶ Tagging release as $TAG"

      - name: ðŸ’¾ Configure Git remote (PAT)
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.WORKFLOW_PAT }}@github.com/${{ github.repository }}.git
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"

      - name: ðŸ§¾ Commit updated checksum
        run: |
          cp SHA256SUMS.txt SHA256SUMS_latest.txt
          git add SHA256SUMS.txt SHA256SUMS_latest.txt || true
          git commit -m "ðŸ§¾ Auto-update SHA256SUMS (${{ env.TAG }})" || echo "No checksum changes"
          git push origin main || echo "No push performed"

      - name: ðŸ”– Create and push tag
        run: |
          git tag -a "${{ env.TAG }}" -m "Automated LTSS release"
          git push origin "${{ env.TAG }}"

      - name: ðŸš€ Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.WORKFLOW_PAT }}
          tag_name: ${{ env.TAG }}
          name: "R3C Rust-LTSS Stable Auto Release ${{ env.TAG }}"
          body: |
            âœ… Automated LTSS stable release
            - Rust version: 1.70.0 (frozen)
            - Includes verified SHA256SUMS for Linux/macOS/Windows
            - Works even without Cargo.toml (environment validation mode)
            - Generated automatically by R3C Autonomous System
          files: |
            SHA256SUMS.txt
            builds/**/*
